<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR AR Object Placement with Three.js</title>
  <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
  <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
  <button id="startButton" onclick="activateXR()" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 10px; font-size: 16px;">Start AR</button>
  <script>
    let scene, camera, renderer;
    let controller;
    let objectPlaced = null;
    let isObjectPlaced = false;
    let hitTestSource = null;
    let referenceSpace;

    async function activateXR() {
      if (!navigator.xr) {
        alert("WebXR no es compatible en este dispositivo");
        return;
      }
      
      try {
        document.getElementById("startButton").style.display = "none";
        const canvas = document.createElement("canvas");
        document.body.appendChild(canvas);
        renderer = new THREE.WebGLRenderer({ alpha: true, canvas: canvas });
        renderer.xr.enabled = true;

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera();
        scene.add(camera);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        const session = await navigator.xr.requestSession("immersive-ar", { requiredFeatures: ['hit-test'] });
        renderer.xr.setSession(session);

        referenceSpace = await session.requestReferenceSpace('local');
        const viewerSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

        controller = renderer.xr.getController(0);
        controller.addEventListener("select", placeObject);
        scene.add(controller);

        const loader = new THREE.GLTFLoader();
        loader.load("https://immersive-web.github.io/webxr-samples/media/gltf/sunflower/sunflower.gltf", function(gltf) {
          objectPlaced = gltf.scene;
          objectPlaced.visible = false;
          scene.add(objectPlaced);
        });

        renderer.setAnimationLoop(render);
      } catch (error) {
        console.error("Error iniciando WebXR: ", error);
        alert("No se pudo iniciar WebXR. Verifica los permisos de la cÃ¡mara y la compatibilidad del dispositivo.");
      }
    }

    function placeObject() {
      if (!objectPlaced || isObjectPlaced) return;
      objectPlaced.visible = true;
      isObjectPlaced = true;
    }

    function render(timestamp, frame) {
      if (frame) {
        const session = renderer.xr.getSession();
        if (!session) return;
        const pose = frame.getViewerPose(referenceSpace);
        if (pose) {
          const view = pose.views[0];
          const viewport = session.renderState.baseLayer.getViewport(view);
          renderer.setSize(viewport.width, viewport.height);
          camera.matrix.fromArray(view.transform.matrix);
          camera.projectionMatrix.fromArray(view.projectionMatrix);
          camera.updateMatrixWorld(true);

          if (hitTestSource && !isObjectPlaced) {
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
              const hitPose = hitTestResults[0].getPose(referenceSpace);
              objectPlaced.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
            }
          }
        }
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
